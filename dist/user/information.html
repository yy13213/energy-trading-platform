<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>
        ä»ªè¡¨ç›˜
    </title>
    <!-- <link href="../css.css" rel="stylesheet" type="text/css"> -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link href="../css/ä»ªè¡¨ç›˜/styles.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="../logo/a252611c614b4ad9aa23b814d858f15.png" type="image/x-icon"/>
    <script src="../css/ä»ªè¡¨ç›˜/echarts.js"></script>
</head>

<body>
  <div id="app1">
    <el-row class="tac">
      <el-col :span="12">
        <h3>èƒ½æºäº¤æ˜“å¹³å°</h3>
        <el-menu
          default-active="2"
          class="el-menu-vertical-demo"
          @open="handleOpen"
          @close="handleClose">
          <el-menu-item index="1">
            <i class="el-icon-star-off"></i>
            <el-link href="../user/index.html">ä¸»é¡µ</el-link>
          </el-menu-item>
          <el-menu-item index="2">
            <i class="el-icon-cpu"></i>
            <el-link href="../user/information.html">ä»ªè¡¨ç›˜</el-link>
          </el-menu-item>
          <el-menu-item index="3">
            <i class="el-icon-chat-line-square"></i>
            <el-link href="../user/chat.html">è”ç³»å®¢æœ</el-link>
          </el-menu-item>
          <el-submenu index="4">
            <template slot="title">
              <i class="el-icon-menu"></i>
              <span>äº§æƒäº¤æ˜“</span>
            </template>
            <el-menu-item-group>
              <el-menu-item index="4-1">
                <el-link href="../user/äº§æƒå¸‚åœº.html">äº§æƒå¸‚åœº</el-link>
              </el-menu-item>
              <el-menu-item index="4-2">
                <el-link href="../user/æˆ‘çš„è®¾å¤‡åˆ—è¡¨.html">æˆ‘çš„äº§æƒ</el-link>
              </el-menu-item>
          </el-submenu>
          <el-submenu index="5">
            <template slot="title">
              <i class="el-icon-menu"></i>
              <span>èƒ½æºäº¤æ˜“</span>
            </template>
            <el-menu-item-group>
              <el-menu-item index="5-1">
                <el-link href="../user/èƒ½æºå¸‚åœº.html">èƒ½æºå¸‚åœº</el-link>
              </el-menu-item>
              <el-menu-item index="5-2">
                <el-link href="../user/æˆ‘çš„èƒ½æº.html">æˆ‘çš„èƒ½æº</el-link>
              </el-menu-item>
          </el-submenu>
        </el-menu>
      </el-col>
    </el-row>
  </div>

  <div id="background">
		<img src="../logo/89c2ca188a4c02152ae0a5eeb1c51de.png" class="back" style="width: 100%;height: 100%;margin:0;background-repeat: no-repeat;background-size: cover;">
	</div>

  <div id="energybutton">
    <button type="button" onclick="MyEnergy()">æˆ‘çš„èƒ½æº</button>
  </div>
  <script>
    function MyEnergy(){ 
      window.location.href = '../user/æˆ‘çš„èƒ½æº.html'
    }
  </script>

  <div id="equipmentbutton">
    <button type="button" onclick="MyEquipment()">æˆ‘çš„äº§æƒ</button>
  </div>
  <script>
    function MyEquipment(){ 
      window.location.href = '../user/æˆ‘çš„è®¾å¤‡åˆ—è¡¨.html'
    }
  </script>

  <div id="personal_account">
    <el-row class="block-col-2">
      <el-col :span="12">
        <el-dropdown>
          <template>
            <div class="demo-type">
              <div>
                <el-avatar src="../logo/å¾®ä¿¡å›¾ç‰‡_20230407094333.png"></el-avatar>
              </div>
            </div>
          </template>
          <el-dropdown-menu slot="dropdown" id="logout">
            <el-dropdown-item icon="el-icon-user-solid"><el-link href="../user/ä¸ªäººä¸­å¿ƒ.html">ä¸ªäººä¸­å¿ƒ</el-link></el-dropdown-item>
            <el-dropdown-item icon="el-icon-switch-button" onclick="logout()">é€€å‡ºç™»å½•</el-dropdown-item>
          </el-dropdown-menu>
        </el-dropdown>
      </el-col>
    </el-row>
  </div>
  <div id="root">
    <div id="container" style="height: 100% ;width:400px"></div>
  </div>

  <script type="text/javascript" src="../css/æˆ‘çš„èƒ½æº/echarts.js"></script>
  <script>
      function logout(){ 
              localStorage.setItem('token', '');
              window.localStorage.clear()
              alert(" é€€å‡ºç™»å½• ")
              window.location.href = '../login/login.html'
            }
  </script>
  <!-- import Vue before Element -->
  <script src="../data/vue.js"></script>
  <!-- import JavaScript -->
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<!-- ç¼“å­˜ç³»ç»Ÿ -->
	<script type="text/javascript" src="../common/cache.js"></script>
	<script type="text/javascript">
      var valu1;

      // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿå’Œé¢„åŠ è½½æ•°æ®ä¼˜åŒ–åŠ è½½é€Ÿåº¦
      async function fetchItems() {
          try {
              console.log('âš¡ å¼€å§‹è·å–ä»ªè¡¨ç›˜èƒ½æºæ•°æ®...');
              
              let energyResponse, sellEnergyResponse;
              
              // ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½çš„æ•°æ®
              if (window.dashboardData) {
                  console.log('ğŸš€ ä½¿ç”¨é¢„åŠ è½½çš„èƒ½æºæ•°æ® (ç¬æ—¶åŠ è½½)');
                  energyResponse = { data: window.dashboardData.userEnergy };
                  sellEnergyResponse = { data: window.dashboardData.sellEnergy };
              } else {
                  console.log('ğŸ”„ é¢„åŠ è½½æ•°æ®ä¸å¯ç”¨ï¼Œä½¿ç”¨ç¼“å­˜è¯·æ±‚...');
                  // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿå¹¶å‘è¯·æ±‚
                  [energyResponse, sellEnergyResponse] = await Promise.all([
                      cachedRequest('http://127.0.0.1:8080/get_user_energy'),
                      cachedRequest('http://127.0.0.1:8080/get_user_sell_energy')
                  ]);
              }
              
              valu1 = energyResponse.data;
              valu2 = sellEnergyResponse.data;
              console.log('âœ… ä»ªè¡¨ç›˜èƒ½æºæ•°æ®åŠ è½½å®Œæˆ:', {å‰©ä½™: valu1, äº¤æ˜“ä¸­: valu2});
              
              // åªåœ¨æ‰€æœ‰æ•°æ®åŠ è½½å®Œåæ¸²æŸ“ä¸€æ¬¡å›¾è¡¨
              updateChart();
          } catch (error) {
              console.error('âŒ è·å–ä»ªè¡¨ç›˜èƒ½æºæ•°æ®å¤±è´¥:', error);
              valu1 = 0;
              valu2 = 0;
              updateChart();
          }
      }

      function updateChart() {
          var dom = document.getElementById('container');
          var myChart = echarts.init(dom, null, {
              renderer: 'canvas',
              useDirtyRect: false
          });
          var app = {};

          var option;

          option = {
              tooltip: {
                  trigger: 'item'
              },
              legend: {
                  top: '5%',
                  left: 'center'
              },
              series: [{
                  name: 'Access From',
                  type: 'pie',
                  radius: ['40%', '70%'],
                  avoidLabelOverlap: false,
                  itemStyle: {
                      borderRadius: 10,
                      borderColor: '#fff',
                      borderWidth: 2
                  },
                  label: {
                      show: false,
                      position: 'center'
                  },
                  emphasis: {
                      label: {
                          show: true,
                          fontSize: 20,
                          fontWeight: 'bold'
                      }
                  },
                  labelLine: {
                      show: false
                  },
                  data: [{
                      value: valu1, //åº”è¯¥æ˜¯å‰©ä½™èƒ½æºå‡å»å†äº¤æ˜“ä¸­çš„èƒ½æº
                      name: 'å‰©ä½™èƒ½æº'
                  },
                  {
                      value: valu2,
                      name: 'äº¤æ˜“ä¸­çš„èƒ½æº'
                  }
                  ]
              }]
          };

          if (option && typeof option === 'object') {
              myChart.setOption(option);
          }

          window.addEventListener('resize', myChart.resize);
      }

      // å¹¶å‘åŠ è½½æ‰€æœ‰ä»ªè¡¨ç›˜æ•°æ®
      async function initializeDashboard() {
          console.log('ğŸš€ ä»ªè¡¨ç›˜å¹¶å‘åŠ è½½å¼€å§‹...');
          const startTime = performance.now();
          
          try {
              // å¹¶å‘è¯·æ±‚æ‰€æœ‰éœ€è¦çš„æ•°æ®
              const [energyResponse, equipmentResponse] = await Promise.all([
                  // è·å–èƒ½æºæ•°æ®çš„å¤šä¸ªæ¥å£
                  Promise.all([
                      cachedRequest('http://localhost:8080/get_user_energy'),
                      cachedRequest('http://localhost:8080/get_user_sell_energy')
                  ]),
                  // è·å–è®¾å¤‡æ•°æ®
                  cachedRequest('http://localhost:8080/get_user_selling_equipment')
              ]);
              
              const endTime = performance.now();
              console.log(`âš¡ ä»ªè¡¨ç›˜æ•°æ®å¹¶å‘åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`);
              
              // å¤„ç†èƒ½æºæ•°æ®
              const [userEnergyRes, sellEnergyRes] = energyResponse;
              window.dashboardData = {
                  userEnergy: userEnergyRes.data || 0,
                  sellEnergy: sellEnergyRes.data || 0,
                  equipment: equipmentResponse.data || []
              };
              
              console.log('ğŸ“Š ä»ªè¡¨ç›˜æ•°æ®ç¼“å­˜å®Œæˆ:', window.dashboardData);
              
              // æ¸²æŸ“å›¾è¡¨
              fetchItems(); // èƒ½æºå›¾è¡¨
              fetchItems1(); // è®¾å¤‡å›¾è¡¨
              
          } catch (error) {
              console.error('âŒ ä»ªè¡¨ç›˜æ•°æ®åŠ è½½å¤±è´¥:', error);
              // é™çº§ï¼šå•ç‹¬åŠ è½½
              fetchItems();
              fetchItems1();
          }
      }
      
      // å¯åŠ¨ä»ªè¡¨ç›˜
      initializeDashboard();
      
  </script>

  <div id="root1">
    <div id="container1" style="width: 600px;height:400px;"></div>
  </div>

  <script type="text/javascript">
    var addTime = []
    var price = []
    
    // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿå’Œé¢„åŠ è½½æ•°æ®ä¼˜åŒ–è®¾å¤‡æ•°æ®è·å–
    async function fetchItems1() {
        try {
            console.log('ğŸ“ˆ å¼€å§‹è·å–ç”¨æˆ·å‡ºå”®è®¾å¤‡æ•°æ®...')
            
            let response;
            
            // ä¼˜å…ˆä½¿ç”¨é¢„åŠ è½½çš„æ•°æ®
            if (window.dashboardData && window.dashboardData.equipment) {
                console.log('ğŸš€ ä½¿ç”¨é¢„åŠ è½½çš„è®¾å¤‡æ•°æ® (ç¬æ—¶åŠ è½½)');
                response = { data: window.dashboardData.equipment };
            } else {
                console.log('ğŸ”„ é¢„åŠ è½½æ•°æ®ä¸å¯ç”¨ï¼Œä½¿ç”¨ç¼“å­˜è¯·æ±‚...');
                // ä½¿ç”¨ç¼“å­˜ç³»ç»Ÿè·å–æ•°æ®
                response = await cachedRequest('http://127.0.0.1:8080/get_user_selling_equipment');
            }
            
            console.log('ğŸ“Š è·å–åˆ°è®¾å¤‡æ•°æ®:', response.data)
            
            // æ¸…ç©ºä¹‹å‰çš„æ•°æ®
            addTime = []
            price = []
            
            // å¤„ç†å“åº”æ•°æ®
            if (response.data && response.data.length > 0) {
                for (let i = 0; i < response.data.length; i++) {
                    addTime.push(response.data[i].addTime)
                    price.push(parseFloat(response.data[i].price))
                }
                console.log('âœ… è®¾å¤‡æ•°æ®å¤„ç†å®Œæˆ:', {æ—¶é—´: addTime.length, ä»·æ ¼: price.length})
            } else {
                console.log('ğŸ“Š æ²¡æœ‰æ­£åœ¨å‡ºå”®çš„è®¾å¤‡')
            }
            
            // æ•°æ®è·å–å®Œæˆåæ¸²æŸ“å›¾è¡¨
            renderChart()
        } catch (error) {
            console.error('âŒ è·å–è®¾å¤‡æ•°æ®å¤±è´¥:', error)
            renderChart() // å³ä½¿å¤±è´¥ä¹Ÿæ¸²æŸ“ç©ºå›¾è¡¨
        }
    }
    
    function renderChart() {
        console.log('ğŸ¨ å¼€å§‹æ¸²æŸ“å›¾è¡¨...')
        
        var chartDom = document.getElementById('container1')
        if (!chartDom) {
            console.error('âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨')
            return
        }
        
        var myChart = echarts.init(chartDom)
        
        var option = {
            title: {
                text: 'æ‚¨æ­£åœ¨å‡ºå”®çš„äº§æƒ',
                subtext: 'time-price'
            },
            xAxis: {
                data: addTime,
                axisLabel: {
                    inside: true,
                    color: '#fff',
                    interval: 0,
                    formatter: function (value) {
                        return value.split('').join('\n')
                    }
                },
                axisTick: {
                    show: false
                },
                axisLine: {
                    show: false
                },
                z: 10
            },
            yAxis: {
                axisLine: {
                    show: false
                },
                axisTick: {
                    show: false
                },
                axisLabel: {
                    color: '#999'
                }
            },
            dataZoom: [
                {
                    type: 'inside'
                }
            ],
            series: [
                {
                    type: 'bar',
                    showBackground: true,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#83bff6' },
                            { offset: 0.5, color: '#188df0' },
                            { offset: 1, color: '#188df0' }
                        ])
                    },
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#2378f7' },
                                { offset: 0.7, color: '#2378f7' },
                                { offset: 1, color: '#83bff6' }
                            ])
                        }
                    },
                    data: price
                }
            ]
        }
        
        // ç‚¹å‡»ç¼©æ”¾åŠŸèƒ½
        const zoomSize = 6
        myChart.on('click', function (params) {
            myChart.dispatchAction({
                type: 'dataZoom',
                startValue: addTime[Math.max(params.dataIndex - zoomSize / 2, 0)],
                endValue: addTime[Math.min(params.dataIndex + zoomSize / 2, price.length - 1)]
            })
        })

        myChart.setOption(option)
        console.log('âœ… å›¾è¡¨æ¸²æŸ“å®Œæˆ')
        
        window.addEventListener('resize', function() {
            myChart.resize()
        })
    }
    
    // é¡µé¢åŠ è½½åè·å–æ•°æ®
    fetchItems1()
      
    
     


  </script>

  <script>
      new Vue({
      el: '#app1',
      data: function() {
          return { visible: false }
      }
      })
      new Vue().$mount('#personal_account')

      new Vue({
      el: '#app',
      data() {
          return {
              isAuthenticated: false,
              username: 'å®Œæˆ'
          }
      },
      methods: {
        // æ·»åŠ  token éªŒè¯é€»è¾‘
        verifyToken(token, secret) {
            // è§£ç  tokenï¼ŒéªŒè¯æ˜¯å¦è¿‡æœŸä»¥åŠç­¾åæ˜¯å¦æ­£ç¡®
              const decoded = verify(token, secret);
              // è¿”å› token åŒ…å«çš„ä¿¡æ¯
              return decoded;
          }
      },

        })

  </script>
</body>

</html>